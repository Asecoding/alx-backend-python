#!/bin/bash

# Script: kubctl-0x01
# Purpose: Scale Django app, verify pods, load test with wrk, and monitor resource usage

DEPLOYMENT_NAME="messaging-app"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default"  # Change if using a different namespace
PORT=8000

echo "üîß Scaling deployment '$DEPLOYMENT_NAME' to 3 replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas=3 --namespace="$NAMESPACE"

echo "üîç Verifying running pods..."
kubectl get pods --namespace="$NAMESPACE" -l app="$DEPLOYMENT_NAME"

echo "‚è≥ Waiting for pods to be ready..."
kubectl wait --for=condition=ready pod -l app="$DEPLOYMENT_NAME" --timeout=60s --namespace="$NAMESPACE"

echo "üöÄ Performing load test using wrk..."
# Get ClusterIP of the service
CLUSTER_IP=$(kubectl get svc "$SERVICE_NAME" --namespace="$NAMESPACE" -o jsonpath='{.spec.clusterIP}')
echo "Targeting service at $CLUSTER_IP:$PORT"

# Run wrk for 10 seconds with 12 threads and 400 connections
wrk -t12 -c400 -d10s http://$CLUSTER_IP:$PORT/

echo "üìä Monitoring resource usage..."
kubectl top pods --namespace="$NAMESPACE"

